#!/usr/bin/expect -f

set timeout 30
set ip [lindex $argv 0]
set user [lindex $argv 1]
set password [lindex $argv 2]
set port [lindex $argv 3]
set length [llength $argv]
if {$length>=5} {
  set ip1 [lindex $argv 4]
  set rsa_pub [lindex $argv 5]
  set rsa_pub_replace [lindex $argv 6]
}
if {$length>=9} {
  set ip2 [lindex $argv 5]
  set user2 [lindex $argv 6]
  set password2 [lindex $argv 7]
  set port2 [lindex $argv 8]
  set rsa_pub [lindex $argv 9]
  set rsa_pub_replace [lindex $argv 10]
}

spawn ssh $user@$ip -p $port
expect "*password*"
send "$password\r"
if {$length>=5} {
  expect "*ID*"
  send "$ip1\r"
  if [string compare $rsa_pub ""] {
    expect "*$*"
    send "sed -i '/$rsa_pub_replace/d' ~/.ssh/authorized_keys && echo $rsa_pub >> ~/.ssh/authorized_keys\r"
  }
}
if {$length>=9} {
  expect "*$*"
  send "ssh $user2@$ip2 -p $port2\r"
  expect "*password*"
  send "$password2\r"
  if [string compare $rsa_pub ""] {
    expect "*$*"
    send "sed -i '/rsa_pub_replace/d' ~/.ssh/authorized_keys && echo $rsa_pub >> ~/.ssh/authorized_keys\r"
  }
}

interact

